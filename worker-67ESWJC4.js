addEventListener("message",({data:n})=>{let r=n.cumulatedTimeLaps,e=n.paces,u=n.lastLapNumberByRaceNumber,t=n.lapSimulatorConfig,a=t.referenceRaceNumber,o=k(r,a),c=w(r,o),m=C(c,o,a,u),s=h(r,e,u,o,t);console.log(s),postMessage({normalizedCumulatedTimeLaps:c,shadowLaps:m,futureLaps:s})});function h(n,r,e,u,t){let a=[],o=new Map,c=n;for(let m=0;m<t.simulatedLaps;m++){let s=g(c),i=L(s),p=T(s,r),f=L(p);[...n.keys()].forEach(b=>{let S=d(i,f,b),l=p.get(b);l&&(c.get(b)?.push(l),o.has(b)||o.set(b,[l]),o.get(b)?.push(l))})}return o.forEach((m,s)=>{let i=e.get(s);if(i){let p=i+1,f=M(m,u,p);a.push({startLapNumber:p,cumulatedTimeLaps:new Map([[s,f]])})}}),a}function d(n,r,e){let u=[],t=[],a=n.get(e),o=r.get(e);return a===void 0||o===void 0?{overtakenRaceNumbers:[],overtakenByRaceNumbers:[]}:(n.forEach((c,m)=>{if(m!==e){let s=r.get(m);s!==void 0&&(a>=c&&o<s&&u.push(m),c>=a&&s<o&&t.push(m))}}),{overtakenRaceNumbers:u,overtakenByRaceNumbers:t})}function g(n){let r=new Map;return n.forEach((e,u)=>{r.set(u,e[e.length-1])}),r}function L(n){let r=new Map,e=[];return n.forEach((u,t)=>{e.push({raceNumber:t,totalLapTimeMilliseconds:u})}),e.sort((u,t)=>t.totalLapTimeMilliseconds-u.totalLapTimeMilliseconds),e.forEach((u,t)=>{r.set(u.raceNumber,t+1)}),r}function T(n,r){let e=new Map;return n.forEach((u,t)=>{let a=r.get(t)||0;e.set(t,u+a)}),e}function k(n,r){if(n.has(r)){let e=n.get(r);return e&&e.length>0?e[e.length-1]/(e.length-1):0}return 0}function M(n,r,e){return r===0?n:n.map((u,t)=>(e+t)*r-u)}function w(n,r){if(r===0)return n;let e=new Map;return n.forEach((u,t)=>{let a=M(u,r,0);e.set(t,a)}),e}function C(n,r,e,u){let t=[],a=u.get(e);return a&&n.forEach((o,c)=>{if(e!==c){let m=u.get(c);if(m&&m!==a){let s=a-m,i=E(o,r,s);t.push({cumulatedTimeLaps:new Map([[c,i]]),startLapNumber:s>=0?s:0})}}}),t}function E(n,r,e){let u=[];return e<0&&(n=n.slice(Math.abs(e))),n.forEach(t=>{u.push(t+r*e)}),u}
